<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Class: ModRails::MessageChannel</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Class</span><br />ModRails::MessageChannel</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../files/lib/mod_rails/message_channel_rb.html">lib/mod_rails/message_channel.rb</a>
        </td>
      </tr>
    <tr>
      <td>Parent:</td>
      <td>
Object
     </td>
   </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
TODO: synchronize this documentation with the C++ one This class can be
wrapped around an IO object to provide the ability to send and receive
discrete messages over byte streams. Messages are lists of strings, with at
least one element in each list.
</p>
<p>
Use <a href="MessageChannel.html">MessageChannel</a> as follows:
</p>
<pre>
 r, w = IO.pipe

 writer_channel = MessageChannel.new(w)
 writer_channel.write(&quot;rm&quot;, &quot;-rf&quot;, &quot;/&quot;)
 writer_channel.close

 reader_channel = MessageChannel.new(r)
 reader_channel.read    # =&gt; [&quot;rm&quot;, &quot;-rf&quot;, &quot;/&quot;]
 reader_channel.read    # =&gt; nil (EOF)
</pre>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000056">close</a></li>
  <li><a href="#M000049">new</a></li>
  <li><a href="#M000050">read</a></li>
  <li><a href="#M000051">read_scalar</a></li>
  <li><a href="#M000054">recv_io</a></li>
  <li><a href="#M000055">send_io</a></li>
  <li><a href="#M000052">write</a></li>
  <li><a href="#M000053">write_scalar</a></li>
  </ul>

<div class="sectiontitle">Included Modules</div>
<ul>
  <li>NativeSupport</li>
</ul>



  <div class="sectiontitle">Constants</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class="attr-name">HEADER_SIZE</td>
    <td>=</td>
    <td class="attr-value">2</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">DELIMITER</td>
    <td>=</td>
    <td class="attr-value">&quot;\0&quot;</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">DELIMITER_NAME</td>
    <td>=</td>
    <td class="attr-value">&quot;null byte&quot;</td>
  </tr>
  </table>

  <div class="sectiontitle">Attributes</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>io</td>
    <td class='attr-desc'>
The wrapped IO object.

</td>
  </tr>
  </table>

<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000049"></a><b>new</b>(io)
  </div>
  <div class="description">
  <p>
Create a <a href="MessageChannel.html#M000049">new</a> <a
href="MessageChannel.html">MessageChannel</a> by wrapping the given IO
object.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000049_source')" id="l_M000049_source">show source</a> ]</p>
  <div id="M000049_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mod_rails/message_channel.rb, line 32</span>
32:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">io</span>)
33:                 <span class="ruby-ivar">@io</span> = <span class="ruby-identifier">io</span>
34:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000056"></a><b>close</b>()
  </div>
  <div class="description">
  <p>
Close the underlying IO stream. Raises IOError if the stream is already
closed.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000056_source')" id="l_M000056_source">show source</a> ]</p>
  <div id="M000056_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mod_rails/message_channel.rb, line 153</span>
153:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close</span>
154:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">close</span>
155:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000050"></a><b>read</b>()
  </div>
  <div class="description">
  <p>
Read the next message from the channel. This method will block until enough
data for a message has been received. Returns the message (a list of
strings), or nil when end-of-stream has been reached. If the stream is
already closed, then nil will be returned as well.
</p>
<p>
What exceptions this method may raise, depends on what calling
readpartial() on the underlying IO object may raise. UNIXSocket objects and
pipes created by IO.pipe() never seem to raise any exceptions.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000050_source')" id="l_M000050_source">show source</a> ]</p>
  <div id="M000050_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mod_rails/message_channel.rb, line 45</span>
45:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read</span>
46:                 <span class="ruby-identifier">buffer</span> = <span class="ruby-value str">''</span>
47:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">HEADER_SIZE</span>
48:                         <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-constant">HEADER_SIZE</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
49:                 <span class="ruby-keyword kw">end</span>
50:                 
51:                 <span class="ruby-identifier">chunk_size</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-value str">'n'</span>)[<span class="ruby-value">0</span>]
52:                 <span class="ruby-identifier">buffer</span> = <span class="ruby-value str">''</span>
53:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">chunk_size</span>
54:                         <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-identifier">chunk_size</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
55:                 <span class="ruby-keyword kw">end</span>
56:                 
57:                 <span class="ruby-identifier">message</span> = []
58:                 <span class="ruby-identifier">offset</span> = <span class="ruby-value">0</span>
59:                 <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
60:                 <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">delimiter_pos</span>.<span class="ruby-identifier">nil?</span>
61:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
62:                                 <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&quot;</span>
63:                         <span class="ruby-keyword kw">else</span>
64:                                 <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">buffer</span>[<span class="ruby-identifier">offset</span> <span class="ruby-operator">..</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]
65:                         <span class="ruby-keyword kw">end</span>
66:                         <span class="ruby-identifier">offset</span> = <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
67:                         <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
68:                 <span class="ruby-keyword kw">end</span>
69:                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">message</span>
70:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
71:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
72:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000051"></a><b>read_scalar</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000051_source')" id="l_M000051_source">show source</a> ]</p>
  <div id="M000051_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mod_rails/message_channel.rb, line 74</span>
74:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_scalar</span>
75:                 <span class="ruby-identifier">buffer</span> = <span class="ruby-value str">''</span>
76:                 <span class="ruby-identifier">temp</span> = <span class="ruby-value str">''</span>
77:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>
78:                         <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-value">4</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">temp</span>)
79:                 <span class="ruby-keyword kw">end</span>
80:                 <span class="ruby-identifier">size</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-value str">'N'</span>)[<span class="ruby-value">0</span>]
81:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
82:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span>
83:                 <span class="ruby-keyword kw">else</span>
84:                         <span class="ruby-identifier">buffer</span> = <span class="ruby-value str">''</span>
85:                         <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">size</span>
86:                                 <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">temp</span>)
87:                         <span class="ruby-keyword kw">end</span>
88:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">buffer</span>
89:                 <span class="ruby-keyword kw">end</span>
90:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
91:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
92:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000054"></a><b>recv_io</b>()
  </div>
  <div class="description">
  <p>
Receive an IO object (a file descriptor) from the channel. The other side
must have sent an IO object by calling <a
href="MessageChannel.html#M000055">send_io</a>(). Note that this only works
on Unix sockets. Please <a href="MessageChannel.html#M000050">read</a>
about Unix sockets file descriptor passing for more information.
</p>
<p>
Raises SocketError if the next item in the IO stream is not a file
descriptor, or if end-of-stream has been reached. Raises IOError if the IO
stream is already closed on this side.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000054_source')" id="l_M000054_source">show source</a> ]</p>
  <div id="M000054_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mod_rails/message_channel.rb, line 128</span>
128:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">recv_io</span>
129:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:recv_io</span>)
130:                         <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">recv_io</span>
131:                 <span class="ruby-keyword kw">else</span>
132:                         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">IO</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">recv_fd</span>(<span class="ruby-ivar">@io</span>.<span class="ruby-identifier">fileno</span>))
133:                 <span class="ruby-keyword kw">end</span>
134:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000055"></a><b>send_io</b>(io)
  </div>
  <div class="description">
  <p>
Send an IO object (a file descriptor) over the channel. The other side must
receive the IO object by calling <a
href="MessageChannel.html#M000054">recv_io</a>(). Note that this only works
on Unix sockets. Please <a href="MessageChannel.html#M000050">read</a>
about Unix sockets file descriptor passing for more information.
</p>
<p>
Raises Errno::EPIPE if the other side of the IO stream has already closed
the connection. Raises IOError if the IO stream is already closed on this
side.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000055_source')" id="l_M000055_source">show source</a> ]</p>
  <div id="M000055_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mod_rails/message_channel.rb, line 144</span>
144:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_io</span>(<span class="ruby-identifier">io</span>)
145:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:send_io</span>)
146:                         <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">send_io</span>(<span class="ruby-identifier">io</span>)
147:                 <span class="ruby-keyword kw">else</span>
148:                         <span class="ruby-identifier">send_fd</span>(<span class="ruby-ivar">@io</span>.<span class="ruby-identifier">fileno</span>, <span class="ruby-identifier">io</span>.<span class="ruby-identifier">fileno</span>)
149:                 <span class="ruby-keyword kw">end</span>
150:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000052"></a><b>write</b>(name, *args)
  </div>
  <div class="description">
  <p>
Write a <a href="MessageChannel.html#M000049">new</a> message into the
message channel. <em>name</em> is the first element in the message name,
and <em>args</em> are the other elements. These arguments will internally
be converted to strings by calling to_s().
</p>
<p>
Raises Errno::EPIPE if the other side of the IO stream has already closed
the connection. Raises IOError if the IO stream has already been closed on
this side.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000052_source')" id="l_M000052_source">show source</a> ]</p>
  <div id="M000052_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mod_rails/message_channel.rb, line 101</span>
101:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write</span>(<span class="ruby-identifier">name</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
102:                 <span class="ruby-identifier">check_argument</span>(<span class="ruby-identifier">name</span>)
103:                 <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
104:                         <span class="ruby-identifier">check_argument</span>(<span class="ruby-identifier">arg</span>)
105:                 <span class="ruby-keyword kw">end</span>
106:                 
107:                 <span class="ruby-identifier">message</span> = <span class="ruby-node">&quot;#{name}#{DELIMITER}&quot;</span>
108:                 <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
109:                         <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DELIMITER</span>
110:                 <span class="ruby-keyword kw">end</span>
111:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">write</span>([<span class="ruby-identifier">message</span>.<span class="ruby-identifier">size</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'n'</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">message</span>)
112:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">flush</span>
113:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000053"></a><b>write_scalar</b>(data)
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000053_source')" id="l_M000053_source">show source</a> ]</p>
  <div id="M000053_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mod_rails/message_channel.rb, line 115</span>
115:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write_scalar</span>(<span class="ruby-identifier">data</span>)
116:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">write</span>([<span class="ruby-identifier">data</span>.<span class="ruby-identifier">size</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'N'</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span>)
117:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">flush</span>
118:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>